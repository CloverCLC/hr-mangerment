<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.cloverclc.dao.EmployeeDao">
    <select id="selectEmployeePage" resultType="cn.cloverclc.model.vo.EmployeeVO" >
        SELECT
            e.empno AS empno,
            e.ename AS name,
            d.dname AS dname,
            -- 计算总收入(工资+所有奖金)
            (e.sal + COALESCE(SUM(b.comm), 0)) AS totalIncome,
            s.grade AS salgrade,
            -- 联系方式优先取mobile，没有则取紧急联系人电话
            CASE
                WHEN e.mobile IS NOT NULL THEN e.mobile
                ELSE e.emergency_contact ->> 'phone'
                END AS contactInfo,
            -- 下级员工姓名(使用字符串聚合)
            array_to_string(array_agg(sub_emp.ename), ',', '') AS subordinateNames
        FROM emp e
                 LEFT JOIN dept d ON e.deptno = d.deptno
                 LEFT JOIN salgrade s ON e.sal BETWEEN s.losal AND s.hisal
                 LEFT JOIN bonus b ON e.empno = b.empno
            -- 关联下级员工
                 LEFT JOIN emp sub_emp ON e.empno = sub_emp.mgr AND sub_emp.ename IS NOT NULL
            WHERE e.deleted = FALSE
        GROUP BY e.empno, e.ename, d.dname, s.grade, e.mobile, e.emergency_contact
        ORDER BY e.empno ASC
    </select>
    <select id="selectEmployeeByDept" resultType="cn.cloverclc.model.vo.DeptVO">
        SELECT
            e.ename AS empName, -- 员工姓名
            e.job AS job, -- 员工职位
            e.hiredate AS hiredate, -- 雇佣时间
            -- 联系方式：优先取手机号，手机号为空则取紧急联系人（兼容JSON格式）
            CASE
                WHEN e.mobile IS NOT NULL AND e.mobile != '' THEN e.mobile
                ELSE e.emergency_contact ->> 'phone'
                END AS contactInfo,
            m.ename AS managerName -- 上级员工姓名（自连接关联）
        FROM emp e
                 -- 自连接：关联上级员工（e.mgr = m.empno，e是员工，m是上级）
                 LEFT JOIN emp m ON e.mgr = m.empno
        -- 按部门筛选（传入部门编号）
        WHERE e.deptno = #{deptno}
          -- 排除无效数据（可选，根据业务需求调整）
          AND e.ename IS NOT NULL
        ORDER BY e.empno ASC
    </select>
</mapper>